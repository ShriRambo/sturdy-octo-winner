<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>USB-Fan Controller for Cooling External Hard-drive</title>
<meta name="generator" content="Org mode">
<link rel="stylesheet" href=" ./css/code.css" />
<link rel="stylesheet" href="./css/simple.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css" integrity="sha256-XoaMnoYC5TH6/+ihMEnospgm0J1PM/nioxbOUdnM8HY=" crossorigin="anonymous">
<link rel="shortcut icon" href="./img/favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="content">
<h1 class="title">USB-Fan Controller for Cooling External Hard-drive</h1>

<div id="outline-container-orgd42a1ed" class="outline-2">
<h2 id="orgd42a1ed">The Problem</h2>
<div class="outline-text-2" id="text-orgd42a1ed">
<p>
I have an old laptop repurposed as a home server, which I use to stream media, backup, and a simple file server. As it is an old laptop, the storage capacity is not enough. So I just bought an external hard-drive to extend the capacity. I know, there are better ways to add storage capacity. But, I thought, this is very straightforward and cheap way to achieve the goal. Now, as the hdd is always connected to the server, it can get pretty hot when being used extensively. So I wanted to have a solution to cool the hdd whenever the temperature rises above a certain threshold. Simplest solution, a &euro;2 usb fan controlled by ESP8266 based microcontroller. Here is a list of all tools/packages/devices I used for this project
</p>

<ul class="org-ul">
<li><a href="https://components101.com/switches/5v-single-channel-relay-module-pinout-features-applications-working-datasheet">Relay switch module</a></li>
<li>USB fan</li>
<li><a href="https://www.smartmontools.org">Smartmontools</a> package to monitor S.M.A.R.T. stats of hdd</li>
<li><a href="https://www.wemos.cc/en/latest/d1/d1_mini.html">Wemos D1 Mini</a> (<code>ESP8266</code> based board)</li>
<li>MQTT broker (like <a href="https://mosquitto.org">mosquitto</a>)</li>
<li><a href="https://components101.com/displays/tm1637-grove-4-digit-display-module">TM1677 7-segment display module</a></li>
</ul>
</div>
</div>


<div id="outline-container-org67a5675" class="outline-2">
<h2 id="org67a5675">üé™ The Circuit</h2>
<div class="outline-text-2" id="text-org67a5675">
<p>
Here is the circuit setup I started with. 
</p>

<div id="orgb2a1b6a" class="figure">
<p><img src="./img/circuit-diagram-fan-controller.png" alt="circuit-diagram-fan-controller.png">
</p>
<p><span class="figure-number">Figure 1: </span>Circuit Diagram</p>
</div>

<p>
The whole setup is powered be USB port of my laptop. The usb cable I used has a <code>GND</code> and <code>5V</code> wire, which is powering both Wemos and the fan. The <code>GND</code> of fan is connected via the relay switch which is controlled by wemos.
</p>
</div>
</div>

<div id="outline-container-org8e5e8d3" class="outline-2">
<h2 id="org8e5e8d3">üëÇüèæ The Sensor</h2>
<div class="outline-text-2" id="text-org8e5e8d3">
<p>
New hdds these days comes with a functionality to report the S.M.A.R.T. stats which gives information about the hard drive, which can be interpreted to evaluate hdds health and detect a failure before it happens. The linux tool called <code>smartmontools</code> lets us read this data and carry out some health check test on hdd. Here is the bash script I use to check the temperature of hdd and publish it to the mqtt server. Note: the flag <code>--nocheck=standby</code> is there to avoid polling of smart stats if the hdd is in standby or sleep mode. Otherwise, the disk will start spinning again when polled for this data. And we do not want to spin up the disk unnecessarily. The script is used in a cron job running every x minutes.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>

smartctl --nocheck=standby -a /dev/sdb &gt; ~/hdd_smart.stats
<span class="org-variable-name">exitCode</span>=$<span class="org-variable-name">?</span>
<span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">(</span> $<span class="org-variable-name">exitCode</span> != 0<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> <span class="org-string">"Nonzero exit code"</span>
    <span class="org-keyword">exit</span> 0
<span class="org-keyword">fi</span>

<span class="org-variable-name">HDD_TEMP</span>=$<span class="org-rainbow-delimiters-depth-1">(</span>grep Temperature_Celsius ~/hdd_smart.stats | awk <span class="org-string">'{print $10}'</span><span class="org-rainbow-delimiters-depth-1">)</span>

mosquitto_pub -h localhost -t home/server/hdd/temperature -m $<span class="org-variable-name">HDD_TEMP</span>
</pre>
</div>

<p>
Important note: The version of smartmontools I have only allows the output in plain text format which can vary with the manufacturer of hdd. Or better option will be to use newer version of smartmontools which allows a json output, which is easier to parse.
</p>
</div>
</div>

<div id="outline-container-orgba586c0" class="outline-2">
<h2 id="orgba586c0">üéÆ The Controller</h2>
<div class="outline-text-2" id="text-orgba586c0">
<p>
The logic for Wemos is written in <code>C++</code> in Arduino IDE, compiled and uploaded to the controller. 
</p>

<p>
Required packages
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">ESP8266WiFi.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string"><span class="org-rainbow-delimiters-depth-1">&lt;</span></span><span class="org-string">PubSubClient.h</span><span class="org-string"><span class="org-rainbow-delimiters-depth-1">&gt;</span></span>
<span class="org-preprocessor">#include</span> <span class="org-string">"config.h"</span> <span class="org-comment-delimiter">// </span><span class="org-comment">Contains all teh configurations</span>
</pre>
</div>

<p>
Initialization of MQTT client and wifi client:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">WiFiClient</span> <span class="org-variable-name">espClient</span>;
<span class="org-type">PubSubClient</span> <span class="org-function-name">client</span><span class="org-rainbow-delimiters-depth-1">(</span>espClient<span class="org-rainbow-delimiters-depth-1">)</span>;

<span class="org-type">int</span> <span class="org-variable-name">relayIP</span> = D7;
<span class="org-type">int</span> <span class="org-variable-name">tlast</span>;

<span class="org-type">void</span> <span class="org-function-name">connectWifi</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class="org-comment">connecting to a WiFi network</span>
  WiFi.begin<span class="org-rainbow-delimiters-depth-2">(</span>ssid, password<span class="org-rainbow-delimiters-depth-2">)</span>;
  Serial.print<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Connicting WiFi"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span>WiFi.status<span class="org-rainbow-delimiters-depth-3">()</span> != WL_CONNECTED<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
      delay<span class="org-rainbow-delimiters-depth-3">(</span>200<span class="org-rainbow-delimiters-depth-3">)</span>;
      Serial.println<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Connecting to WiFi.."</span><span class="org-rainbow-delimiters-depth-3">)</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  Serial.println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Connected to the WiFi network"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  Serial.print<span class="org-rainbow-delimiters-depth-2">(</span>WiFi.localIP<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span>;

<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">connectMqttBroker</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">//</span><span class="org-comment">connecting to a mqtt broker</span>
  <span class="org-keyword">while</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>client.connected<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
      <span class="org-type">String</span> <span class="org-variable-name">client_id</span> = <span class="org-string">"fan_controller"</span>;
      <span class="org-comment-delimiter">//</span><span class="org-comment">client_id += String(WiFi.macAddress());</span>
      Serial.printf<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"The client %s connects to the home broker\n"</span>, client_id.c_str<span class="org-rainbow-delimiters-depth-4">()</span><span class="org-rainbow-delimiters-depth-3">)</span>;
      <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-3">(</span>client.connect<span class="org-rainbow-delimiters-depth-4">(</span>client_id.c_str<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
          Serial.println<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"Connected to mqtt broker"</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          client.subscribe<span class="org-rainbow-delimiters-depth-4">(</span>topic<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-rainbow-delimiters-depth-3">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-3">{</span>
          Serial.print<span class="org-rainbow-delimiters-depth-4">(</span><span class="org-string">"failed with state "</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          Serial.print<span class="org-rainbow-delimiters-depth-4">(</span>client.state<span class="org-rainbow-delimiters-depth-5">()</span><span class="org-rainbow-delimiters-depth-4">)</span>;
          delay<span class="org-rainbow-delimiters-depth-4">(</span>2000<span class="org-rainbow-delimiters-depth-4">)</span>;
      <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">reconnect</span><span class="org-rainbow-delimiters-depth-1">(){</span>
  connectWifi<span class="org-rainbow-delimiters-depth-2">()</span>;
  connectMqttBroker<span class="org-rainbow-delimiters-depth-2">()</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>


<p>
Whenever a new temperature reading is published on the topic, the callback function receives and parse the message. If the temperature is greater than <code>tmax</code>, the fan is turned on. If the temperature is less than <code>tmin</code> the fan is turned off. I have set <code>tmin &lt; tmax</code> because if they are the same, the fan might switch on and off very frequently.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">callback</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-type">char</span>* <span class="org-variable-name">topic</span>, <span class="org-type">byte</span>* <span class="org-variable-name">payload</span>, <span class="org-type">unsigned</span> <span class="org-type">int</span> <span class="org-variable-name">length</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  Serial.print<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Message arrived ["</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  Serial.print<span class="org-rainbow-delimiters-depth-2">(</span>topic<span class="org-rainbow-delimiters-depth-2">)</span>;
  Serial.print<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"] "</span><span class="org-rainbow-delimiters-depth-2">)</span>;

  payload<span class="org-rainbow-delimiters-depth-2">[</span>length<span class="org-rainbow-delimiters-depth-2">]</span> = <span class="org-string">'\0'</span>;
  tlast = String<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-type">char</span>*<span class="org-rainbow-delimiters-depth-3">)</span> payload<span class="org-rainbow-delimiters-depth-2">)</span>.toInt<span class="org-rainbow-delimiters-depth-2">()</span>;

  Serial.println<span class="org-rainbow-delimiters-depth-2">(</span>tlast<span class="org-rainbow-delimiters-depth-2">)</span>;
  Serial.println<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>tlast &gt; tmax<span class="org-rainbow-delimiters-depth-2">){</span>
    fanOn<span class="org-rainbow-delimiters-depth-3">()</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>tlast &lt; tmin<span class="org-rainbow-delimiters-depth-2">){</span>
    fanOff<span class="org-rainbow-delimiters-depth-3">()</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>  
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
</div>

<p>
The functions for fan on and fan off are described below. They just switch the fan, switch the builtin led to indicate fan status and publish the fan state to another mqtt topic.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">fanOn</span><span class="org-rainbow-delimiters-depth-1">(){</span>
  Serial.println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Fan On"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  digitalWrite<span class="org-rainbow-delimiters-depth-2">(</span>LED_BUILTIN, LOW<span class="org-rainbow-delimiters-depth-2">)</span>;
  digitalWrite<span class="org-rainbow-delimiters-depth-2">(</span>relayIP, LOW<span class="org-rainbow-delimiters-depth-2">)</span>;
  client.publish<span class="org-rainbow-delimiters-depth-2">(</span>topic_pub, <span class="org-string">"on"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-type">void</span> <span class="org-function-name">fanOff</span><span class="org-rainbow-delimiters-depth-1">(){</span>
  Serial.println<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"Fan Off"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
  digitalWrite<span class="org-rainbow-delimiters-depth-2">(</span>LED_BUILTIN, HIGH<span class="org-rainbow-delimiters-depth-2">)</span>;
  digitalWrite<span class="org-rainbow-delimiters-depth-2">(</span>relayIP, HIGH<span class="org-rainbow-delimiters-depth-2">)</span>;
  client.publish<span class="org-rainbow-delimiters-depth-2">(</span>topic_pub, <span class="org-string">"off"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>


<p>
Putting it all together with setup and loop function. 
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span class="org-type">void</span> <span class="org-function-name">setup</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  Serial.begin<span class="org-rainbow-delimiters-depth-2">(</span>BAUDE_RATE<span class="org-rainbow-delimiters-depth-2">)</span>;
  Serial.println<span class="org-rainbow-delimiters-depth-2">()</span>;

  pinMode<span class="org-rainbow-delimiters-depth-2">(</span>LED_BUILTIN, OUTPUT<span class="org-rainbow-delimiters-depth-2">)</span>;
  pinMode<span class="org-rainbow-delimiters-depth-2">(</span>relayIP,OUTPUT<span class="org-rainbow-delimiters-depth-2">)</span>;

  <span class="org-comment-delimiter">//</span><span class="org-comment">Connect wIfi</span>
  connectWifi<span class="org-rainbow-delimiters-depth-2">()</span>;

  <span class="org-comment-delimiter">//</span><span class="org-comment">Connect MQTT broker</span>
  client.setServer<span class="org-rainbow-delimiters-depth-2">(</span>mqtt_broker, mqtt_port<span class="org-rainbow-delimiters-depth-2">)</span>;
  client.setCallback<span class="org-rainbow-delimiters-depth-2">(</span>callback<span class="org-rainbow-delimiters-depth-2">)</span>;
  connectMqttBroker<span class="org-rainbow-delimiters-depth-2">()</span>;

  delay<span class="org-rainbow-delimiters-depth-2">(</span>1500<span class="org-rainbow-delimiters-depth-2">)</span>;    
  client.publish<span class="org-rainbow-delimiters-depth-2">(</span><span class="org-string">"esp/test"</span>, <span class="org-string">"Hello from ESP8266"</span><span class="org-rainbow-delimiters-depth-2">)</span>;
<span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">the loop function runs over and over again forever</span>
<span class="org-type">void</span> <span class="org-function-name">loop</span><span class="org-rainbow-delimiters-depth-1">()</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  client.loop<span class="org-rainbow-delimiters-depth-2">()</span>;
  <span class="org-comment-delimiter">// </span><span class="org-comment">Reconnect if connection breaks</span>
  <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-negation-char">!</span>client.connected<span class="org-rainbow-delimiters-depth-3">()</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    Serial.println<span class="org-rainbow-delimiters-depth-3">(</span><span class="org-string">"Reconnecting"</span><span class="org-rainbow-delimiters-depth-3">)</span>;
    reconnect<span class="org-rainbow-delimiters-depth-3">()</span>;
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-orge0dbceb" class="outline-2">
<h2 id="orge0dbceb">üåØ The Wrap-up</h2>
<div class="outline-text-2" id="text-orge0dbceb">
<p>
So, with this setup, I cool my external hdd when it gets too warm. And if the disk is in sleep mode, this does not spin it up again time to time. Although, there is one problem that I have noticed. If the fan is on and hdd goes to sleep, the fan will not shut off as there is no temperature measurement taken when in sleep. To tackle this, I want to implement a timer after which the fan will shut off automatically regardless the hdd status. And if it is still hot, the fan will start up again.
</p>


<hr>
<script src="https://giscus.app/client.js" 
  data-repo="ShriRambo/giscus-comments"
  data-repo-id="R_kgDOG1mtrQ"
  data-category="Announcements" 
  data-category-id="DIC_kwDOG1mtrc4CBJNW" 
  data-mapping="title" 
  data-reactions-enabled="1" 
  data-emit-metadata="0" 
  data-input-position="top" 
  data-theme="dark" 
  data-lang="en" 
  crossorigin="anonymous" 
  async> </script>
<hr>
<p style="text-align:center">
Made with ‚ù§Ô∏è and Emacs (Org-mode)
</p>
<div align=center>
  <a href="#">
    <i class="fa fa-home fa-lg link-icon" aria-hidden="true"></i>
  </a>
  <a href="https://www.instagram.com/shrirambo/">
    <i class="fa fa-instagram fa-lg link-icon" aria-hidden="true"></i>
  </a>
  <a href="https://github.com/shrirambo">
    <i class="fa fa-github fa-lg link-icon" aria-hidden="true"></i>
  </a>
  <a href='https://www.linkedin.com/in/shriram-ashirgade/'>
    <i class="fa fa-linkedin-square fa-lg link-icon" aria-hidden="true"></i>
  </a>
  <a href='https://github.com/ShriRambo/sturdy-octo-winner/tree/master/content'>
    <i class="fa fa-code  fa-lg link-icon" aria-hidden="true"></i>
  </a>
  <a href='#content'>
    <i class="fa fa-hand-o-up  fa-lg link-icon" aria-hidden="true"></i>
  </a>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="validation"></p>
</div>
</body>
</html>
